# GitLab CI configuration file for pushing tagged versions
# of the code as archive to zenodo, based on documentation
# at https://pypi.org/project/gitlab2zenodo/
#
# SPDX-FileCopyrightText: 2023-2025 Helmholtz-Zentrum hereon GmbH
# SPDX-License-Identifier: CC0-1.0
# SPDX-FileContributor Carsten Lemmen <carsten.lemmen@hereon.de

image: python:3.12

send-snapshot:
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+/
  script:
    - pip install gitlab2zenodo
    - git archive --format zip --output ${CI_COMMIT_TAG#v}.zip ${CI_COMMIT_TAG}
    # Need to find the right document id for -i argument
    - g2z-send -i XXXXXX -t ${ZENODO_APIKEY}} -m .zenodo.json ${CI_COMMIT_TAG#v}.zip
  needs: []
  allow_failure: true
  interruptible: true

send-sandbox-snapshot:
  stage: deploy
  rules:
    - if: $CI_COMMIT_TAG =~ /^v?[0-9]+\.[0-9]+/
  script:
    - pip install gitlab2zenodo
    - git archive --format zip --output ${CI_COMMIT_TAG#v}.zip ${CI_COMMIT_TAG}
    # Need to find the right document id for -i argument
    - g2z-send -i XXXXX -t ${ZENODO_SANDBOX} -s -m .zenodo.json ${CI_COMMIT_TAG#v}.zip
  needs: []
  allow_failure: true
  interruptible: true
